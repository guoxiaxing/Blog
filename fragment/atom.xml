<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://guoxiaxing.github.io/Blog/fragment</id>
    <title>Try's Blog Blog</title>
    <updated>2021-12-24T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://guoxiaxing.github.io/Blog/fragment"/>
    <subtitle>Try's Blog Blog</subtitle>
    <icon>https://guoxiaxing.github.io/Blog/img/logo.jpeg</icon>
    <entry>
        <title type="html"><![CDATA[formControlçš„disabledå±æ€§ç»‘å®šä¸ç”Ÿæ•ˆ]]></title>
        <id>angular-form-contol-disabled</id>
        <link href="https://guoxiaxing.github.io/Blog/fragment/angular-form-contol-disabled"/>
        <updated>2021-12-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[èƒŒæ™¯]]></summary>
        <content type="html"><![CDATA[<h2>èƒŒæ™¯</h2><p>æˆ‘æƒ³åœ¨ç»„ä»¶çš„æŸä¸€ä¸ªå±æ€§ä¸º true çš„æ—¶å€™ç¦ç”¨æˆ‘çš„ checkboxï¼Œæ‰€ä»¥æˆ‘å°±åœ¨ type=&#x27;checkbox&#x27;çš„ input æ¡†ä¸Šæ·»åŠ äº†ä¸€ä¸ªæ•°æ®ç»‘å®š<code>[disabled]=&#x27;!!readonly&#x27;</code>å¹¶ä¸”æˆ‘ç¡®å®šæˆ‘çš„ readonly å±æ€§æ˜¯ trueï¼Œç„¶è€Œï¼Œç»“æœè®©æˆ‘å¤§åƒä¸€æƒŠï¼Œæ²¡æœ‰ç”Ÿæ•ˆï¼Œæ€ä¹ˆä¼šè¿™æ ·ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><h2>ä»£ç </h2><pre><code class="language-html">&lt;label&gt;
  &lt;input
    type=&quot;checkbox&quot;
    formControlName=&quot;correct&quot;
    [style]=&quot;{ verticalAlign: &#x27;text-bottom&#x27; }&quot;
    [disabled]=&quot;!!readonly&quot;
  /&gt;
  æ˜¯
&lt;/label&gt;
</code></pre><p>å¤é€‰æ¡†ä»ç„¶å¯ä»¥é€‰æ‹©
ä½†æ˜¯æˆ‘å‘ç°å½“æˆ‘ç»™ä¸‹é¢çš„å•é€‰æ¡†è®¾ç½®ä¸€æ ·çš„ disabled å±æ€§çš„æ—¶å€™ï¼Œå®ƒæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå†çœ‹çœ‹å®ƒçš„ä»£ç </p><pre><code class="language-html">&lt;label&gt;
  &lt;input
    type=&quot;radio&quot;
    [checked]=&quot;!!item.value.correct&quot;
    (change)=&quot;onRadioChange(i)&quot;
    [style]=&quot;{ verticalAlign: &#x27;text-bottom&#x27; }&quot;
    [disabled]=&quot;!!readonly&quot;
  /&gt;
  æ˜¯
&lt;/label&gt;
</code></pre><p>è¿™ä¸ªç»“æœæ›´æ˜¯è®©æˆ‘æ‘¸ä¸ç€å¤´è„‘ ğŸ˜­</p><h2>æ’æŸ¥è¿‡ç¨‹</h2><ol><li>ç›´æ¥ç»™<!-- -->[disabled]<!-- -->=&#x27;true&#x27; -&gt; ä¸ç”Ÿæ•ˆ âŒ</li><li>ç›´æ¥è®¾ç½® disabled å±æ€§ -&gt; ç”Ÿæ•ˆï¼Œå› ä¸ºè¿™å°±ç›¸å½“äºæ“ä½œäº† input æ ‡ç­¾æœ¬èº«çš„ html å±æ€§ï¼Œå’Œ angular å°±æ²¡å•¥å…³ç³»äº† âœ…</li><li>diasbled=&#x27;disabled&#x27; -&gt; ç”Ÿæ•ˆï¼ŒåŸå› åŒäºŒ âœ…</li><li>[disabled]<!-- --> = &#x27;readonly ? &quot;disabled&quot; : &quot;&quot;&#x27; -&gt; ä¸ç”Ÿæ•ˆ âŒ</li></ol><p>ç„¶åæˆ‘ä¼¼ä¹æ€»ç»“å‡ºäº†è§„å¾‹ï¼Œåªè¦æ˜¯åœ¨ input ä¸Šä½¿ç”¨äº† angular çš„æ•°æ®ç»‘å®šï¼Œå³ä½¿è®¡ç®—ä¹‹åçš„å€¼æ˜¯å¯¹çš„ï¼Œä¹Ÿæ˜¯æ— æ³•ç”Ÿæ•ˆçš„ï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨ html çš„ input æ ‡ç­¾çš„å±æ€§å°±æ˜¯å¯ä»¥çš„ï¼ï¼ï¼æ‰€ä»¥æ˜¯ angular ç»‘å®šçš„æ—¶å€™å‡ºé—®é¢˜äº†ï¼Ÿï¼Ÿï¼Ÿ</p><h2>å‘ç° Bug</h2><p>åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œæˆ‘ç»ˆäºå‘ç°äº†ä¸€äº›ä¸ä¸€æ ·çš„ä¸œè¥¿ã€‚
åŸæ¥ï¼Œä¸ç”Ÿæ•ˆçš„åŸå› æ˜¯ï¼Œæˆ‘çš„ type=&#x27;checkbox&#x27;çš„ input æ˜¯ä¸€ä¸ª formControlï¼Œæ‰€ä»¥ angular æ›´å¸Œæœ›ä½ é€šè¿‡ç»™ fromControl å®ä¾‹è®¾ç½® disabled æ¥ç¦ç”¨å®ƒï¼Œè€Œä¸æ˜¯åœ¨å®ƒä¸Šé¢ç»‘å®š<!-- -->[disabled]<!-- -->å±æ€§ï¼ï¼ï¼ï¼è€Œä¸”å…¶å® angular æ˜¯ç»™æˆ‘æŠ¥äº†ä¸€ä¸ªè­¦å‘Šçš„ï¼Œåªä¸è¿‡å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªè­¦å‘Š âš ï¸ æ‰€ä»¥æˆ‘è®¤ä¸ºå®ƒå¹¶ä¸ä¼šæ˜¯å¯¼è‡´æˆ‘ä»£ç ä¸ç”Ÿæ•ˆçš„åŸå› ï¼ï¼ï¼ç²—å¿ƒå¤§æ„å¤ªè¯¯äººäº† ğŸ¤¦â€â™€</p><h2>è§£å†³æ–¹å¼</h2><ol><li>å½“ç„¶æ˜¯ä½¿ç”¨ angular æ¨èçš„æ–¹å¼ï¼Œé€šè¿‡ä½ çš„ formControl å®ä¾‹æ¥ disabled è¿™ä¸ªè¡¨å•é¡¹</li></ol><pre><code class="language-typescript">formControl.disable(); // ç¦ç”¨
formControl.enable(); // å¯ç”¨
</code></pre><ol start="2"><li>ä½†æ˜¯ï¼Œç”±äºæˆ‘çš„è¿™æ®µä»£ç å¹¶ä¸æ˜¯æˆ‘å†™çš„ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨äº†ä¸€ç§å·å·§çš„æ–¹å¼ï¼Œç›´æ¥è®¾ç½® input åŸç”Ÿçš„ disabled å±æ€§ï¼Œä¹Ÿæ˜¯å¯ä»¥è¾¾åˆ°æœŸæœ›çš„</li></ol><pre><code class="language-html">&lt;label fncFormItem&gt;
  &lt;input
    type=&quot;checkbox&quot;
    formControlName=&quot;correct&quot;
    [style]=&quot;{ verticalAlign: &#x27;text-bottom&#x27; }&quot;
    [attr.disabled]=&quot;!!readonly ? &#x27;&#x27; : null&quot;
  /&gt;
  æ˜¯
&lt;/label&gt;
</code></pre><h2>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.cnblogs.com/z7luv/p/15015895.html">angular çš„ formControl çš„ disabled å±æ€§ç»‘å®šä¸ç”Ÿæ•ˆ</a></p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Angular ChangeDetection]]></title>
        <id>angular-ChangeDetection</id>
        <link href="https://guoxiaxing.github.io/Blog/fragment/angular-ChangeDetection"/>
        <updated>2021-12-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[ChangeDetection æ˜¯ä»€ä¹ˆ]]></summary>
        <content type="html"><![CDATA[<h2>ChangeDetection æ˜¯ä»€ä¹ˆ</h2><p>æ•°æ®é©±åŠ¨çš„ UIï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯åªéœ€è¦æ”¹å˜ component é‡Œçš„æ•°æ®ï¼Œç„¶å template é‡Œçš„ UI å…ƒç´ å°±é­”æ³•èˆ¬åœ°è‡ªåŠ¨å˜æˆæœ€æ–°çš„å±•ç°äº†ã€‚ChangeDetection å°±æ˜¯ Angular å®ç°æ•°æ®é©±åŠ¨ UI çš„æ–¹å¼ã€‚</p><h2>ChangeDetectionStrategy.Default</h2><p>è¿™æ˜¯é»˜è®¤çš„é­”æ³•æ–¹æ¡ˆï¼Œçœå¿ƒçœäº‹å„¿ï¼Œèƒ½æŠŠäº‹æƒ…åŠå¥½ï¼Œæˆ‘ä»¬å•¥ä¹Ÿä¸ç”¨ç®¡ã€‚</p><h2>detectChange å®ç°</h2><p>ä»»ä½•æ•°æ®æ”¹å˜ï¼ŒAngular éƒ½èƒ½å‘ç°å¹¶æ›´æ–° UIã€‚è¿™æ˜¯å› ä¸º Angular ä¼šåœ¨åˆé€‚æ—¶æœºè¿è¡Œ detectChangeï¼Œå¹¶é‡æ–°è·å–ä¸€éæ•°æ®æ•°æ®ç»‘å®šçš„å€¼ï¼Œå¹¶ä¸ä¸Šä¸€æ¬¡çš„å€¼è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœä¸ä¸€æ ·çš„è¯å°±ä¼šè¿›è¡Œ UI æ”¹å˜ã€‚</p><p>Angular å¯¹ Object çš„æ£€æµ‹åªæ˜¯ç®€å•æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œæ”¹å˜ object.count ä¸ä¼šè§¦å‘ child çš„ inObj çš„å˜åŒ–ï¼Œä½†æ˜¯ detectChange ä¹Ÿä¼š detect æ‰€æœ‰ child ç»„ä»¶çš„å˜åŒ–ã€‚äºæ˜¯ child ç»„ä»¶ä¹Ÿä¼šå†æ£€æŸ¥ä¸€éã€‚</p><p>*<!-- -->ngFor è¿™ç§ä¸œè¥¿è‡ªå·±å†…éƒ¨ä¼šåœ¨æ¯æ¬¡ detectChange çš„æ—¶å€™å¯¹æ¯” array çš„æ–°å¢ã€å‡å°‘ã€è°ƒåºã€‚</p><h2>detectChange æ—¶æœº</h2><p>ä½†æ˜¯ Angular æ¯”è¾ƒæœºæ™ºçš„æ˜¯ï¼Œå®ƒä¼šåœ¨ä¸€äº›äº‹ä»¶å®Œæˆçš„æ—¶å€™è‡ªåŠ¨è§¦å‘ detectChangeã€‚è¿™äº›åŒ…æ‹¬ï¼š</p><ul><li>æ‰€æœ‰æµè§ˆå™¨äº‹ä»¶ï¼ˆclickã€keyupã€mouseover ç­‰ï¼‰</li><li>æ‰€æœ‰ addEventListener çš„ callback å®Œæˆå</li><li>æ‰€æœ‰ Ajax è¯·æ±‚å</li><li>æ‰€æœ‰çš„ setTimeout å’Œ setInterval çš„å›è°ƒè§¦å‘å</li><li>ï¼ˆæµè§ˆå™¨è‡ªå¸¦çš„ï¼‰Websockets çš„å„äº‹ä»¶ï¼ˆoncloseã€onopenã€onmessage ç­‰ï¼‰</li><li>Promiseï¼ˆresolveã€reject...ï¼‰</li><li>NgZone.runã€NgZone.runTask...</li><li>...</li></ul><p>è¿™äº›äº‹æƒ…å‘ç”Ÿçš„æ—¶å€™ï¼Œéƒ½æ˜¯æœ‰æ¯”è¾ƒå¤§çš„æ¦‚ç‡ä¼šå¼•èµ· UI æ”¹å˜çš„ã€‚æ¯”å¦‚ click é©±ä½¿çš„æ”¹å˜ã€æ–°ç½‘ç»œè¯·æ±‚æ•°æ®é©±ä½¿çš„æ”¹å˜ä¹‹ç±»ä¹‹ç±»ã€‚</p><p>Angular åº•å±‚çš„ ngZone é€šè¿‡ zone.js æ¥å¯¹æµè§ˆå™¨çš„ addEventListener ç­‰æ–¹æ³•åš patchï¼Œä»è€Œç›‘å¬è¿™äº›äº‹ä»¶çš„è§¦å‘æ—¶æœºè€Œè¿è¡Œ detectChange</p><p>Angular è¿™äº› detectChange çš„è°ƒç”¨éƒ½æ˜¯ä» root node è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¼šæ£€æŸ¥æ•´ä¸ªåº”ç”¨çš„ç»‘å®šå€¼</p><h2>DetectionStrategy.OnPush</h2><p>è™½ç„¶ Default çš„ç­–ç•¥å¾ˆç¾å¥½ï¼ŒAngular çš„ detectChanges çš„æ€§èƒ½ä¹Ÿä¸é”™ï¼Œä½†æ˜¯å¯¹äºå¤§ä¸€äº›çš„åº”ç”¨æ¥è¯´ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶éƒ½æ£€æŸ¥æ•´ä¸ªç»„ä»¶æ ‘è¿˜æ˜¯ä¼šæœ‰æ€§èƒ½é—®é¢˜çš„ã€‚å¯ä»¥å‡å°‘ä¸å¿…è¦çš„æ£€æµ‹ä»è€Œæé«˜æ€§èƒ½</p><p>OnPush è™½ç„¶éœ€è¦æˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨ markForCheckï¼Œä½†æ˜¯æœ‰ä¸‰ç§æƒ…å†µ Angular ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è°ƒç”¨ï¼š</p><ul><li>@Input</li><li>AsyncPipe</li><li>Browser äº‹ä»¶</li></ul><p>OnPush ç›¸å…³çš„ä¸¤ä¸ªæ¥å£:</p><ul><li>markForCheck - æ ‡è®°ä¸º dirtyã€‚ä¸‹æ¬¡æœ‰ detectChange çš„æ—¶å€™æ›´æ–° UI</li><li>detectChange - ç«‹å³å¯¹å½“å‰ç»„ä»¶è¿›è¡Œ detectChangeï¼Œå³ä½¿ç»„ä»¶è¿è¡Œåœ¨ ngZone ä¹‹å¤–ï¼ŒåŒæ­¥æ›´æ–° UI</li></ul><h3>OnPush ä¸»è¦åŸåˆ™</h3><p>å…¶ä¸»è¦åŸåˆ™å°±æ˜¯æ²¡æœ‰è¢«æ ‡è®° markForCheck çš„ç»„ä»¶åœ¨ changeDetection æ—¶ä¼šè¢«ç›´æ¥è·³è¿‡</p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒsetTimeoutã€setIntervalã€ç½‘ç»œè¯·æ±‚ä¹‹ç±»çš„äº‹ä»¶åï¼ŒAngular ä¼šä» root å‘èµ· detectChangeï¼Œä½†æ˜¯é‡åˆ° onPush æ—¶ï¼Œå¦‚æœæ²¡æœ‰è¢« markForCheckï¼Œå°±ä¼šè·³è¿‡è¿™æ•´ä¸ªèŠ‚ç‚¹ä»¥åŠå…¶å­èŠ‚ç‚¹ï¼ˆå­èŠ‚ç‚¹æ— è®ºæ˜¯ OnPush ç­–ç•¥è¿˜æ˜¯ Default ç­–ç•¥éƒ½ä¼šè¢«è·³è¿‡ï¼‰</p><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬çŸ¥é“éœ€è¦æ›´æ–° UI çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° UI æ—¶ï¼Œéœ€è¦è°ƒç”¨ markForCheck()</p><p>ç»è¿‡ markForCheck æ ‡è®°åçš„ OnPush ç»„ä»¶ï¼Œä¼šæŠŠè‡ªå·±æ‰€æœ‰ OnPush çš„çˆ¶ç»„ä»¶éƒ½æ ‡è®°ä¸º dirtyï¼Œä¸‹æ¬¡æ‰§è¡Œ detectChange çš„æ—¶å€™å°±ä¼šæŠŠéœ€è¦æ£€æŸ¥çš„éƒ½æå®šã€‚
ç¨å¾®æœ‰å‡ ä¸ªç»†èŠ‚ï¼š</p><ul><li>è‡ªå·±çš„å­ç»„ä»¶å¦‚æœæ˜¯ Default çš„è¯ï¼Œä¼šåœ¨è‡ªå·±è¿è¡Œ detectChange çš„æ—¶å€™ä¹Ÿæ£€æŸ¥ä¸€é</li><li>å¦‚æœè‡ªå·±çš„å­ç»„ä»¶æ˜¯ OnPush å¹¶ä¸”å­ç»„ä»¶è‡ªå·±æ²¡æœ‰ markForCheckï¼Œé‚£ä¹ˆ detectChange å°±ä¼šè¢«è·³è¿‡</li><li>å¦‚æœ OnPush æ²¡æœ‰è¢« markForCheckï¼Œé‚£ä¹ˆå³ä½¿è‡ªå·±çš„å­ç»„ä»¶æ˜¯ Defaultï¼Œä¹Ÿä¸ä¼šè¢«æ£€æŸ¥</li></ul><p>åœ¨ä¸€äº›æƒ…å†µä¸‹ Angular ä¼šè‡ªåŠ¨ç»™æˆ‘ä»¬çš„ OnPush ç»„ä»¶æ ‡è®° markForCheckã€‚</p><h3>@Input å±æ€§å‘ç”Ÿæ”¹å˜çš„æ—¶å€™</h3><p>å½“ç»™å­ç»„ä»¶ç»‘å®šçš„@Input å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼ŒAngular ä¼šè‡ªåŠ¨ç»™å­ç»„ä»¶æ ‡è®° markForCheckï¼Œå¹¶åœ¨ detectChange çš„æ—¶å€™æ›´æ–° UIï¼Œä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨ markForCheckã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„å‡ ä¸ªç»†èŠ‚ï¼š</p><h4>ä¸ä¼šè¿›è¡Œæ·±åº¦æ£€æŸ¥</h4><p>ä¸Šé¢æåˆ°è¿‡ï¼ŒAngular çš„ changeDetection å¯¹ Object åªæ£€æŸ¥æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸ä¼šè¿›è¡Œæ·±åº¦æ£€æŸ¥ã€‚æ‰€æœ‰æ”¹å˜ä»»ä½• Object å†…åµŒçš„å€¼ï¼Œæˆ–è€…ç»™ array.push ä¹‹ç±»çš„æ“ä½œï¼Œéƒ½ä¸ä¼šè‡ªåŠ¨è§¦å‘ markForCheckã€‚</p><pre><code class="language-html">&lt;app-child [inCount]=&quot;count&quot; [inObj]=&quot;obj&quot; [inArr]=&quot;array&quot;&gt; &lt;/app-child&gt;
</code></pre><pre><code class="language-typescript">public count: number = 0;
public obj: { count: number; other: number } = { count: 0, other: 4 }
public array: number[] = [];

// will trigger mark
this.count = 2;
this.obj = {...obj, count: 2};
this.array = [];
this.array = [...this.array];
this.array = this.array.slice(0);

// will not trigger mark
this.obj.count = 6;
this.array.push(1);
this.array.length = 0;
</code></pre><h4>çˆ¶ç»„ä»¶æ˜¯ OnPush</h4><p>æ£€æŸ¥ä¸Šè¿°@Input ç»‘å®šå€¼æ˜¯å¦å˜åŒ–çš„é€»è¾‘ä¸åœ¨å­ç»„ä»¶é‡Œï¼Œè€Œæ˜¯åœ¨çˆ¶ç»„ä»¶ detectChange æ—¶åˆ¤å®šçš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦çˆ¶ç»„ä»¶æ²¡æœ‰è§¦å‘ detectChangeï¼Œå­ç»„ä»¶æ—¢ä¸ä¼š markForCheckï¼Œä¹Ÿä¸ä¼šæ”¹å˜@Input çš„å€¼ã€‚è™½ç„¶ Angular ä¼šç›‘å¬å¾ˆå¤šç›¸å…³æ–¹æ³•ï¼Œå¹¶è‡ªåŠ¨è§¦å‘ detectChangeï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦æ³¨æ„ä¸€äº›ç‰¹æ®Šæƒ…å†µçš„ï¼š</p><pre><code class="language-html">&lt;app-child [inCount]=&quot;count&quot;&gt;&lt;/app-child&gt;
</code></pre><pre><code class="language-typescript">@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class ParentComponent implements OnInit {
  public count: number = 0;

  ngOnInit() {
    interval(1000).subscribe(() =&gt; {
      this.count++; // will not trigger cd for child
    });
  }
}
</code></pre><p>å› ä¸ºæ£€æŸ¥@Input ç»‘å®šå€¼çš„å˜åŒ–æ˜¯åœ¨çˆ¶ç»„ä»¶é‡Œåšçš„ï¼Œæ‰€ä»¥å¦‚æœçˆ¶ç»„ä»¶æ˜¯ OnPush å¹¶ä¸”æ²¡æœ‰æ ‡è®° markForCheckï¼Œé‚£ä¹ˆå­ç»„ä»¶ä¹Ÿä¸ä¼šè§¦å‘ cdã€‚</p><p>è¿™é‡Œè™½ç„¶æ¯æ¬¡è§¦å‘ interval åéƒ½ä¼šæœ‰ detectChange å‘ç”Ÿï¼Œä½†æ˜¯å› ä¸ºçˆ¶ç»„ä»¶æ˜¯ OnPush å¹¶ä¸”æ²¡æœ‰è¢« markForCheckï¼Œæ‰€ä»¥ä¼šç›´æ¥è·³è¿‡ã€‚</p><h4>ngZone ä¹‹å¤–çš„äº‹ä»¶</h4><p>Angular è‡ªåŠ¨è§¦å‘ detectChange éƒ½æ˜¯ ngZone é‡Œçš„äº‹ä»¶è§¦å‘çš„ï¼Œå¦‚æœäº‹ä»¶ä¸åœ¨ ngZone é‡Œçš„è¯ï¼Œå°±ä¸ä¼šè‡ªåŠ¨è§¦å‘ detectChangeã€‚
ä¾‹å­ï¼š</p><pre><code class="language-typescript">import { Component, OnInit, NgZone } from &quot;@angular/core&quot;;

@Component({
  changeDetection: ChangeDetectionStrategy.Default
})
export class ParentComponent implements OnInit {
  public count: number = 0;

  constructor(private ngZone: NgZone) {}

  ngOnInit() {
    // the interval is outside ngZone thus it will not
    // trigger change detection and ui will not update
    this.ngZone.runOutsideAngular(() =&gt; {
      interval(1000).subscribe(() =&gt; {
        this.count++; // will not trigger cd for child
      });
    });
  }
}
</code></pre><p>ä¸Šé¢å”¯ä¸€åŒºåˆ«å°±æ˜¯ç”¨æ¥ ngZone.runOutsideAngular è¿™ä¸ªæ–¹æ³•æŠŠ interval çš„åˆ›å»ºä¸¢åœ¨çš„ Angular çš„ Zone ä¹‹å¤–ã€‚è¿™æ · Angular å°±æ²¡æœ‰ patch è¿™ä¸ª intervalï¼Œä¹Ÿä¸ä¼šåœ¨ interval è§¦å‘çš„æ—¶å€™è°ƒç”¨ detectChange äº†ã€‚</p><p>æ³¨æ„è¿™é‡Œæ˜¯ç›´æ¥ä¸è°ƒç”¨ detectChangeã€‚æ‰€ä»¥å³ä½¿ OnPush çš„ç»„ä»¶è°ƒç”¨äº† markForCheck ä¹Ÿä¸ä¼šæ›´æ–° UIã€‚ç”šè‡³ ChangeDetectionStrategy.Default çš„ç»„ä»¶ä¹Ÿä¸ä¼šæœ‰ UI æ›´æ–°ã€‚å¿…é¡»ç­‰æœ‰å…¶ä»–äº‹ä»¶å‘ç”Ÿï¼Œè§¦å‘ detectChange åï¼ŒUI æ‰ä¼šåˆ·æ–°ã€‚</p><h3>Async Pipe</h3><p>Angular é™¤äº†åœ¨@Input å€¼æ”¹å˜çš„æ—¶å€™ä¼šå†…éƒ¨å¸®æˆ‘ä»¬ markForCheckï¼Œè¿˜æœ‰ Asyc Pipe å‘å°„æ–°å€¼å¾—æ—¶å€™ä¼šå¸®æˆ‘ä»¬ markForCheckã€‚</p><h4>markForCheck on next</h4><p>v9.x çš„è¡¨ç°æ˜¯åªè¦ Observable æœ‰è§¦å‘äº† nextï¼Œ ç»‘å®šäº†è¿™ä¸ª Observable çš„ OnPush ç»„ä»¶å°±ä¼šè¢« markForCheckã€‚ä¸ä¼šæ£€æŸ¥å‘å‡ºçš„å€¼æ˜¯ä¸æ˜¯å’Œä»¥å‰çš„ä¸ä¸€æ ·ã€‚</p><p>ä¾‹å­ï¼š
child ç»„ä»¶ï¼š</p><pre><code class="language-html">&lt;p&gt;count {{ (inObj$ | async)?.count }}&lt;/p&gt;
</code></pre><pre><code class="language-typescript">@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class ChildComponent {
  @Input()
  inObj$: Observable&lt;{ count: number }&gt;;
}
</code></pre><p>parent ç»„ä»¶ï¼š</p><pre><code class="language-html">&lt;app-child [inObj$]=&quot;obj$&quot;&gt;&lt;/app-child&gt;
</code></pre><pre><code class="language-typescript">@Component({
  changeDetection: ChangeDetectionStrategy.Default
})
export class ParentComponent implements OnInit {
  private obj = { count: 1 };
  private _obj$ = new BehaviorSubject(this.obj);
  public obj$ = this._obj$.asObservable();

  ngOnInit() {
    interval(1000).subscribe(() =&gt; {
      this.obj.count++;
      this._obj$.next(this.obj); // Child component will update
    });
  }
}
</code></pre><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿ obj çš„å®ä¾‹ä¸å˜ï¼Œåªè¦è°ƒç”¨äº† async pipe çš„ next è¢«è°ƒç”¨äº†ï¼ŒAngular å°±ä¼šå¸®æˆ‘ä»¬è°ƒç”¨é‚£ä¸ª OnPush ç»„ä»¶çš„ markForCheckã€‚è¿™ä¸ªè¡¨ç°åœ¨ v10.0.0 é‡Œæœ‰æ”¹å˜ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å»è‡ªå·±æµ‹ã€‚</p><h4>ç›´æ¥æ”¹å˜åŸå¯¹è±¡çš„åµŒå¥—å€¼ä¸ä¼šè§¦å‘</h4><p>è¿™é‡Œåªæ˜¯æä¸€ä¸‹ï¼Œv9.x çš„ async pipe åªæ˜¯ç›‘å¬ nextï¼Œæ‰€ä»¥ç›´æ¥æ”¹å˜å®ä¾‹é‡Œé¢çš„å€¼çš„è¯æ˜¯ä¸ä¼š markForCheck çš„</p><pre><code class="language-typescript">// ...
ngOnInit() {
  interval(1000).subscribe(() =&gt; {
    // will not trigger mark for check
    this.obj.count++;
  });
}
// ...
</code></pre><h3>Browser äº‹ä»¶</h3><p>å³ä½¿ä½ çš„ç»„ä»¶ç”¨äº† OnPushï¼Œå®ƒçš„ç›‘å¬çš„ Browser äº‹ä»¶ï¼ˆclickã€mouseoverã€mouseleave ç­‰ï¼‰è§¦å‘çš„æ—¶å€™ï¼ŒAngular éƒ½ä¼šå¸®ä½ è°ƒç”¨ markForCheckã€‚</p><pre><code class="language-html">&lt;span&gt;count is: {{count}}&lt;/span&gt;
&lt;button (click)=&quot;addOneClicked()&quot;&gt;Increment&lt;/button&gt;
</code></pre><pre><code class="language-typescript">@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class TestComponent {
  public count: number = 0;

  public addOneClicked(): void {
    // does not need to call markForCheck if
    // invoked from click handler
    this.count++;
  }
}
</code></pre><h2>NgZone</h2><p>æ¨èä¸€ç¯‡è¯¦ç»†è®² NgZone çš„<a href="https://medium.com/reverse-engineering-angular/angular-deep-dive-zone-js-how-does-it-monkey-patches-various-apis-9cc1c7fcc321">æ–‡ç« </a></p><p>Angular åœ¨ bootstrap çš„æ—¶å€™é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªå« ngZone çš„ zoneã€‚ngZone çš„ä½œç”¨å°±æ˜¯ï¼Œåœ¨è¿™ä¸ª zone é‡Œè¿è¡Œçš„ä»£ç è¢« Angular monkey patch æ‰äº†ï¼ŒåŠ ä¸Šäº† Angular è‡ªå·±çš„åŒ…æ‹¬ changeDetection åœ¨å†…çš„ä¸€äº›å¤„ç†ã€‚å¼€å¤´è¯´çš„ Angular ç›‘å¬ timeoutã€intervalã€click ä¹‹ç±»çš„ä¸œè¥¿ï¼Œå°±æ˜¯é€šè¿‡ ngZone æ¥ç›‘å¬çš„ã€‚</p><p>Angular é€šè¿‡ ngZone æ¥ patch è¿™äº›æ–¹æ³•ï¼Œåè¿‡æ¥ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåœ¨ ngZone ä¹‹å¤–è°ƒç”¨ setIntervalã€addEventListener ä¹‹ç±»çš„ä¸œè¥¿çš„è¯ï¼Œç”¨çš„æ–¹æ³•å°±ä¸æ˜¯ Angular patch è¿‡çš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘ detectChange äº†ã€‚</p><h3>UI åˆ·æ–°ä¸åŠæ—¶</h3><p>ä¸Šé¢æåˆ°  ä¸åœ¨ NgZone é‡Œåˆ›å»º setInterval ä¹‹ç±»çš„ä¸œè¥¿ï¼ŒAngular å°±ä¸ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨è§¦å‘ detectChangeã€‚æˆ‘ä»¬ UI æ›´æ–°ä¸åŠæ—¶çš„é—®é¢˜åŸºæœ¬éƒ½æ˜¯è¿™ä¸ªé€ æˆçš„ã€‚ä¸‹é¢åˆ—ä¸€äº›å¸¸è§çš„åœ¨ ngZone ä¹‹å¤–è¿è¡Œçš„åŸå› ã€‚</p><h4>å…¶ä»–ç¬¬ä¸‰æ–¹ npm åº“</h4><p>Angular å¯¹ç¬¬ä¸‰æ–¹åº“æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œæ‰€ä»¥å¦‚æœç¬¬ä¸‰æ–¹åº“åº•å±‚ç”¨äº† C++ å›è°ƒçš„è¯ï¼Œæˆ‘ä»¬å°±æœ‰å¯èƒ½åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è·‘å‡º NgZone äº†ã€‚éœ€è¦æ³¨æ„ã€‚ä½†æ˜¯ Promise çš„äº‹æƒ…åœ¨è¿™é‡Œä¹Ÿé€‚ç”¨ï¼Œå¦‚æœç¬¬ä¸‰æ–¹åº“æ˜¯ç”¨ Promise çš„è¯ï¼Œåæœ‰å…«ä¹æ˜¯æ²¡é—®é¢˜çš„ã€‚å› ä¸º Angular æŠŠ Promise ç»™ patch äº†ã€‚</p><h4>NgZone ä¹‹å¤–åˆ›å»ºçš„ç»„ä»¶</h4><p>è¿™ä¸ªæ˜¯æ¯”è¾ƒéšæ™¦çš„ä¸€ä¸ªæƒ…å†µã€‚ä¸Šé¢è®² OnPush çš„æ—¶å€™åšçš„ä¸€å¤§ä¸ªå‡è®¾æ˜¯ click ç­‰æµè§ˆå™¨äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ Angular ä¼šè‡ªåŠ¨è°ƒç”¨ detectChange æ¥åˆ·æ–° UIã€‚ä½†æ˜¯è¿™ä¸ªæ˜¯åœ¨ç»„ä»¶åœ¨ NgZone é‡Œåˆ›å»ºçš„å‰æä¸‹æ‰æˆç«‹çš„ã€‚</p><pre><code class="language-html">&lt;button (click)=&quot;onClick()&quot;&gt;&lt;/button&gt;
</code></pre><p>ä¸Šé¢çš„è¿™ç§ templateï¼Œåœ¨åˆ›å»ºè¿™ä¸ª button çš„æ—¶å€™ï¼ŒAngular ä¼šè°ƒç”¨ addEventListener æ¥å¸®æˆ‘ä»¬æŠŠè¯¥åšçš„äº‹æƒ…æå®šã€‚ç„¶åå†å›é¡¾ä¸€ä¸‹ä¹‹å‰ä¹‹å‰è®²çš„ï¼ŒAngular æ˜¯é€šè¿‡ NgZoneï¼ŒæŠŠ addEventListener ç­‰æ–¹æ³• patch äº†ï¼Œæ‰è¾¾åˆ°è‡ªåŠ¨ detectChange çš„æ•ˆæœçš„ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ª button æ˜¯åœ¨ ngZone ä¹‹å¤–åˆ›å»ºçš„ï¼Œé‚£è°ƒç”¨çš„ addEventListener å°±æ˜¯æ²¡æœ‰è¢« patch è¿‡çš„ç‰ˆæœ¬ï¼Œç‚¹å‡»åä¹Ÿå°±ä¸ä¼šä¸»åŠ¨è§¦å‘ detectChangeã€‚ï¼ˆè‡ªåŠ¨çš„ markForCheck è¿˜ä¼šè¿›è¡Œï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯ Angular è§£æ template çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ˜¯ patch å‡ºæ¥çš„ï¼‰</p><p>è¦æ€ä¹ˆåœ¨ ngZone ä¹‹å¤–åˆ›å»ºç»„ä»¶ï¼Ÿ<code>*ngIf</code>ã€<code>*ngFor</code> ç­‰ directive é…åˆåœ¨ zone ä¹‹å¤–æ‰‹åŠ¨è°ƒç”¨ detectChange å°±ä¼šå‘ç”Ÿã€‚</p><p>ä¾‹å­ï¼š</p><pre><code class="language-html">&lt;p&gt;count is: {{count}}&lt;/p&gt;
&lt;div *ngIf=&quot;enable&quot;&gt;
  &lt;button (click)=&quot;onCreatedButtnClick()&quot;&gt;
    Created
  &lt;/button&gt;
&lt;/div&gt;
</code></pre><pre><code class="language-typescript">@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class ParentComponent implements OnInit {
  public count: number = 0;
  public enable: boolean = false;

  constructor(private ngZone: NgZone, private cd: ChangeDetectorRef) {}

  ngOnInit() {
    this.ngZone.runOutsideAngular(() =&gt; {
      interval(1000).subscribe(() =&gt; {
        this.enable = true;

        // we are outside ngZone, so we have to manually
        // call detectChanges so angular can create button
        this.cd.detectChanges();
      });
    });
  }

  onCreatedButtnClick(): void {
    // UI will not update until detectChange is triggered
    // by network or some other component. This is because
    // the button was created outside of angular zone and
    // will not automatically call detectChanges on click
    this.count++;
    this.cd.markForCheck();
  }
}
</code></pre><h3>runOutsideAngular æ€§èƒ½ä¼˜åŒ–</h3><p>æ€§èƒ½å·®ï¼š</p><pre><code class="language-html">&lt;span&gt;time is: {{time}}&lt;/span&gt;
</code></pre><pre><code class="language-typescript">public time: number = 0;

constructor(private ngZone: NgZone, private cd:ChangeDetectorRef) {}

public ngOnInit(): void {
  interval(100).subscribe(_ =&gt; {
    this.time++;
    this.cd.markForCheck(); // é€šå¸¸æƒ…å†µä¸‹ä¸éœ€è¦ï¼Œåœ¨OnPushç­–ç•¥ä¸‹éœ€è¦åŠ 
  });
}
</code></pre><p>ä¸Šé¢è¿™ç§å†™æ³•ï¼Œæ ¹æ®æƒ…å†µï¼Œå¯èƒ½ä¼šæœ‰å¾ˆç³Ÿç³•çš„æ€§èƒ½ã€‚åŸå› æ˜¯ ngZone æŠŠ setInterval ç»™ patch äº†ã€‚æ‰€ä»¥ setInterval çš„æ¯æ¬¡å›è°ƒåï¼Œéƒ½ä¼šè§¦å‘æºäº root node çš„ detectChangeã€‚ä¼šæŠŠæ•´ä¸ªåº”ç”¨éƒ½æ£€æŸ¥ä¸€æ¬¡ã€‚</p><p>è™½ç„¶ OnPush çš„ç»„ä»¶ä¼šè¢«è·³è¿‡ï¼Œä½†æ˜¯ markForCheck ä¼šæŠŠè‡ªå·±æ‰€æœ‰çˆ¶äº²ç»„ä»¶éƒ½ç»™æ ‡è®°ä¸º dirtyã€‚å¦‚æœè‡ªå·±çš„çˆ¶ç»„ä»¶é‡Œæœ‰å¾ˆå¤šæ•°æ®ç»‘å®šçš„è¯ï¼Œä¹Ÿä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚æ›´ä½•å†µæˆ‘ä»¬ä»£ç é‡Œè¿˜æœ‰ä¸å°‘ç»„ä»¶è¿˜æ˜¯ Default çš„ cd ç­–ç•¥...</p><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><pre><code class="language-typescript">public time: number = 0;

constructor(private ngZone: NgZone, private cd:ChangeDetectorRef) {}

public ngOnInit(): void {
  this.ngZone.runOutsideAngular(() =&gt; {
    interval(100).subscribe(_ =&gt; {
      this.time++;
      this.cd.detectChanges();
    }
  });
}
</code></pre><p>åƒè¿™æ ·åœ¨ ngZone ä¹‹å¤–åˆ›å»º interval çš„è¯ï¼Œç”¨çš„å°±ä¸æ˜¯ Angular æ‰“è¿‡çŒ´å­è¡¥ä¸çš„ç‰ˆæœ¬äº†ã€‚æ‰€ä»¥è§¦å‘çš„æ—¶å€™ä¸ä¼šå¯¹æ•´ä¸ªåº”ç”¨è¿›è¡Œ cdã€‚</p><p>å› ä¸ºæ²¡æœ‰ angular çš„ cdï¼Œæˆ‘ä»¬å¿…é¡»è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ä¸€ä¸‹ detectChanges()ã€‚è¿™ä¸ªæ–¹æ³•åªä½œç”¨äºå½“å‰ node ä»¥åŠå…¶å­ç»„ä»¶ã€‚æ‰€ä»¥åƒä¸€ä¸ªç®€å•çš„ timer è¿™æ ·å¯ä»¥ç¡®å®šä¸ä¼šå½±å“åº”ç”¨å…¶ä»–éƒ¨åˆ†çŠ¶æ€çš„ç»„ä»¶ï¼Œå¯ä»¥æ”¾å¿ƒåœ°åªå¯¹å®ƒè¿›è¡Œ cdã€‚</p><p>å½“ç„¶è¿™ä¸ªçš„å‰ææ˜¯ä¸å½±å“åº”ç”¨å…¶ä»–åœ°æ–¹ã€‚å¦‚æœè¦å±•ç¤ºæ—¶é—´ï¼Œä½†æ˜¯æ¯ 10s dispatch ä¸€ä¸ª action çš„è¯ï¼Œåº”è¯¥æŠŠè¿™ä¸ª action ä¸¢å› AngularZone é‡Œé¢æ¥ dispatchï¼Œä»¥è§¦å‘ä¸€æ¬¡å…¨å±€çš„ cdã€‚</p><pre><code class="language-typescript">public ngOnInit(): void {
  this.ngZone.runOutsideAngular(() =&gt; {
    interval(100).subscribe(_ =&gt; {
      this.time++;
      this.cd.detectChanges();

      if (this.time % 100 === 0) {
        // NgZone.runä¼šè§¦å‘ä¸€æ¬¡æºäºroot nodeçš„detectChange
        this.ngZone.run(() =&gt; {
          this.store.dispatch(new Action());
        });
      }
    }
  });
}
</code></pre><p><strong>å¦‚æœ ngZone å¤–è§¦å‘çš„ detectChange è§¦å‘äº†<!-- -->*<!-- -->ngIf ä¹‹ç±»çš„ directive åˆ›å»ºæ–°å…ƒç´ çš„è¯ï¼Œåˆ›å»ºçš„ç»„ä»¶çš„ click ç­‰ handler éƒ½ä¼šåœ¨ ngZone ä¹‹å¤–æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ä¼šè§¦å‘ detectChangeã€‚æ‰€ä»¥è¦æ³¨æ„</strong></p><h2>ChangeDetectorRef.detach çš„éªšæ“ä½œ</h2><h2>Q&amp;A</h2><ul><li>detectChange å’Œ markForCheck çš„åŒºåˆ«ï¼Ÿ</li></ul><p>markForCheck åªæ˜¯æ ‡è®° dirtyï¼Œè‡ªèº«å…¶å®åªæ˜¯æŠŠä¸€ä¸ªå€¼è®¾ç½®ä¸º trueã€‚å®é™…è¿›è¡Œæ•°æ®å¯¹æ¯”ã€UI æ›´æ–°ã€å…ƒç´ åˆ›å»ºçš„æ˜¯ detectChangeã€‚</p><ul><li>ä¸šåŠ¡ç»„ä»¶æœ€ä½³å®è·µï¼ŸonPush + markForCheck/detectChange ç»„åˆï¼Ÿ</li></ul><p>æœ€å¥½æ˜¯å°½å¯èƒ½å¤šçš„ç»„ä»¶ä½¿ç”¨ onPush + markForCheckã€‚detectChange æ˜¯åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸éœ€è¦çš„ã€‚detectChange çš„ä¸€ç§åˆç†çš„ä½¿ç”¨åœºæ™¯æ˜¯ä¸Šé¢æåˆ°çš„ runOutsideAngular çš„æ€§èƒ½ä¼˜åŒ–ã€‚ç›¸å¯¹ç‹¬ç«‹çš„ç»„ä»¶ä½†æ˜¯éœ€è¦é¢‘ç¹æ›´æ–°ã€‚</p>]]></content>
    </entry>
</feed>