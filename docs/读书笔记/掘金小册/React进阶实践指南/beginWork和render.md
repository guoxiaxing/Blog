---
slug: beginWorkå’Œrender
title: beginWorkå’Œrender
tags: [æ˜é‡‘å°å†Œ, Reactè¿›é˜¶å®è·µæŒ‡å—, beginWorkå’Œrender]
---

:::info

fiber è°ƒå’Œæ›´æ–°æ‰§è¡Œçš„å°±æ˜¯ beginWork;ä½†æ˜¯ beginWork å’Œ render å¹¶ä¸ç­‰ä»·ï¼Œrender ä¸€å®šä¼šå¯¼è‡´ beginWork çš„æ‰§è¡Œï¼Œä½†æ˜¯ beginWork æ‰§è¡Œå¹¶ä¸ä¸€å®šä¼šå¯¼è‡´ç»„ä»¶é‡æ–° render.

:::

:::danger

åœ¨ React ä¸­ï¼Œç»„ä»¶æ›´æ–°æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š

- state å‘ç”Ÿæ”¹å˜
- props å‘ç”Ÿæ”¹å˜
- context æ”¹å˜

è€Œä¸”åªæœ‰ç»„ä»¶æ‰èƒ½è§¦å‘æ›´æ–°ï¼Œæ¯”å¦‚ div å…ƒç´  hostComponent ç±»å‹çš„ fiberï¼Œå®ƒæ˜¯æ— æ³•ç‹¬ç«‹çš„è‡ªæˆ‘æ›´æ–°çš„ï¼Œåªèƒ½ä¾èµ–äºçˆ¶ç±»çš„ç»„ä»¶æ›´æ–° stateï¼Œä½†æ˜¯åœ¨è°ƒå’Œé˜¶æ®µï¼Œå®ƒä¹Ÿä¼šä½œä¸ºä¸€ä¸ªä»»åŠ¡å•å…ƒè¿›å…¥åˆ° workLoop ä¸­ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ç»“è®º

- **fiber æ˜¯è°ƒå’Œè¿‡ç¨‹ä¸­çš„æœ€å°å•å…ƒï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½ä¼šè¿›å…¥ workLoop ä¸­ã€‚**

- **è€Œç»„ä»¶ï¼ˆå‡½æ•°/ç±»ï¼‰æ˜¯æœ€å°çš„æ›´æ–°å•å…ƒï¼ŒReact çš„æ›´æ–°æºäºæ•°æ®å±‚ state çš„å˜åŒ–ã€‚**

:::

## beginWork - è°ƒå’Œæºæ³‰

ç±»ç»„ä»¶åœ¨ render é˜¶æ®µä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯äº§ç”Ÿæ–°çš„ childrenã€‚æ¯ä¸€ä¸ªéœ€è¦æ›´æ–°çš„ fiber éƒ½è¦ç»å†ä¸€ä¸ªè¿‡ç¨‹å«åš beginWorkã€‚

:::info

å¯¹äºç»„ä»¶ç±»å‹çš„ fiberï¼Œè¿›å…¥åˆ° workLoop ä¸­å°±ä¸€å®šä¼š rerender å—ï¼Ÿ

no!

:::

### demo

```jsx
/* å­ç»„ä»¶2 */
function Child2() {
  return <div>å­ç»„ä»¶ 2</div>;
}
/* å­ç»„ä»¶1 */
function Child1() {
  const [num, setNumber] = React.useState(0);
  return (
    <div>
      å­ç»„ä»¶ {num}
      <button onClick={() => setNumber(num + 1)}>æŒ‰é’®1</button>
    </div>
  );
}
/* çˆ¶ç»„ä»¶ */
export default function Index() {
  const [num, setNumber] = React.useState(0);
  return (
    <div>
      <p>çˆ¶ç»„ä»¶ {num} </p>
      <Child1 />
      <Child2 />
      <button onClick={() => setNumber(num + 1)}>æŒ‰é’®2</button>
    </div>
  );
}
```

- åœºæ™¯ä¸€ï¼šå½“ç‚¹å‡» Child1 çš„ æŒ‰é’® 1 çš„æ—¶å€™ï¼ŒChild1 ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆ Child1 è‡ªç„¶ä¼šè¿›å…¥åˆ° beginWork æµç¨‹ä¸­ï¼Œé‚£ä¹ˆç–‘é—®æ¥äº†ï¼š

  - é—®é¢˜ä¸€ï¼šçˆ¶ç»„ä»¶ Index æ²¡æœ‰æ›´æ–°ï¼Œä¼š rerender å—ï¼Ÿé‚£ä¹ˆæœ‰ä¼šè¿›å…¥ beginWork æµç¨‹å— ï¼Ÿ
  - é—®é¢˜äºŒï¼šChild2 ä¼šè¿›å…¥ beginWork æµç¨‹å— ï¼Ÿ
  - é—®é¢˜ä¸‰ï¼šå¦‚æœ Index ä¼š beginWorkï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ

- åœºæ™¯äºŒï¼šå½“ç‚¹å‡» Index ä¸­çš„ æŒ‰é’® 2 çš„æ—¶å€™ï¼š

  - é—®é¢˜å››ï¼šIndex å› ä¸ºæœ¬èº«çš„ state æ”¹å˜ä¼šæ›´æ–°ï¼Œé‚£ä¹ˆ Child1 å’Œ Child2 ä¸ºä»€ä¹ˆä¼šè·Ÿç€æ›´æ–°ã€‚

:::danger

ç­”ä¸€ï¼š ä¸ä¼š rerenderï¼›ä¼š beginWork

ç­”äºŒï¼šChild2 ä¼šè¿›å…¥ beginWork æµç¨‹ï¼ˆåŸå› æ˜¯çˆ¶ç»„ä»¶è¿›å…¥äº† beginWorkï¼‰

ç­”ä¸‰ï¼šä¸çŸ¥é“ ğŸ˜­

ç­”å››ï¼šå› ä¸ºçˆ¶ç»„ä»¶ rerender äº†

:::

:::info

æ›´æ–°ä¼˜å…ˆçº§ï¼š

- lane ï¼š æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆåœ¨ä¸€æ¬¡æ›´æ–°ä»»åŠ¡ä¸­ï¼Œå°†èµ‹äºˆç»™æ›´æ–°çš„ fiber çš„ä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ laneã€‚ï¼‰
- childLanesï¼šchildren ä¸­æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆå¦‚æœå½“å‰ fiber çš„ child ä¸­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“å‰ fiber çš„ childLanes ç­‰äºå½“å‰ä¼˜å…ˆçº§ï¼‰ã€‚

:::

## state æ”¹å˜çš„æ—¶å€™ç»„ä»¶å¦‚ä½•æ›´æ–°

- è·å–åˆ° state å‘ç”Ÿæ”¹å˜çš„ç»„ä»¶çš„ fiber å’Œ laneï¼Œè°ƒç”¨ scheduleUpdateOnFiber

- æŠŠå½“å‰ fiber åˆ° rootFiber çš„çˆ¶çº§é“¾è¡¨ä¸Šçš„æ‰€æœ‰ä¼˜å…ˆçº§éƒ½ç»™æ›´æ–°äº†ï¼›å¦‚æœå½“å‰ root fiber ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ ensureRootIsScheduled ï¼Œ

  - ä¼˜å…ˆçº§æ›´æ–°æ–¹æ³•ï¼šé¦–å…ˆä¼šæ›´æ–°å½“å‰ fiber ä¸Šçš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œè¿˜è¦æ›´æ–°å½“å‰ fiber çš„ç¼“å†²æ ‘ alternate ä¸Šçš„ä¼˜å…ˆçº§ï¼›ç„¶åä¼šé€’å½’å‘ä¸ŠæŠŠçˆ¶çº§é“¾ä¸Šçš„ childLanes éƒ½æ›´æ–°ï¼Œæ›´æ–°æˆå½“å‰çš„ä»»åŠ¡ä¼˜å…ˆçº§

:::info

**ä¸ºä»€ä¹ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§çš„ childLanesï¼Ÿ**

- æ‰€æœ‰çš„ fiber æ˜¯é€šè¿‡ä¸€é¢— fiber æ ‘å…³è”åˆ°ä¸€èµ·çš„ï¼Œå¦‚æœç»„ä»¶ A å‘ç”Ÿä¸€æ¬¡æ›´æ–°ï¼ŒReact æ˜¯ä» root å¼€å§‹æ·±åº¦éå†æ›´æ–° fiber æ ‘ã€‚

- é‚£ä¹ˆæ›´æ–°è¿‡ç¨‹ä¸­éœ€è¦æ·±åº¦éå†æ•´ä¸ª fiber æ ‘å—ï¼Ÿï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªç»„ä»¶æ›´æ–°ï¼Œæ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½è°ƒå’Œæ— ç–‘æ˜¯æ€§èƒ½ä¸Šçš„æµªè´¹

- æ—¢ç„¶è¦ä»å¤´æ›´æ–°ï¼Œåˆä¸æƒ³è°ƒå’Œæ•´ä¸ª fiber æ ‘ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„ç»„ä»¶ A å‘¢ï¼Ÿï¼Ÿ**è¿™ä¸ªæ—¶å€™ childLanes å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¦‚æœ A å‘ç”Ÿäº†æ›´æ–°ï¼Œé‚£ä¹ˆå…ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§é“¾çš„ childLanesï¼Œæ¥ä¸‹æ¥ä» Root Fiber å‘ä¸‹è°ƒå’Œçš„æ—¶å€™ï¼Œå‘ç° childLanes ç­‰äºå½“å‰æ›´æ–°ä¼˜å…ˆçº§ updateLanesï¼Œé‚£ä¹ˆè¯´æ˜å®ƒçš„ child é“¾ä¸Šæœ‰æ–°çš„æ›´æ–°ä»»åŠ¡ï¼Œåˆ™ä¼šç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œåä¹‹é€€å‡ºè°ƒå’Œæµç¨‹ã€‚**ï¼ˆé—®é¢˜ä¸‰çš„ç­”æ¡ˆ - Root Fiber æ˜¯é€šè¿‡ childLanes é€æ¸å‘ä¸‹è°ƒå’Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ç»„ä»¶çš„**è¦æ›´æ–°çš„ç»„ä»¶çš„ lane === updateLane**ï¼‰

:::

![1](/img/Reactè¿›é˜¶å®è·µæŒ‡å—/2421bbf350134d438f1bdc12b2882974_tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.png)

- ç¬¬ä¸€é˜¶æ®µæ˜¯å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆäº§ç”Ÿä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ lane ã€‚
- ç¬¬äºŒé˜¶æ®µå‘ä¸Šæ ‡è®° childLanes è¿‡ç¨‹ã€‚
- ç¬¬ä¸‰é˜¶æ®µæ˜¯å‘ä¸‹è°ƒå’Œè¿‡ç¨‹ï¼Œæœ‰çš„åŒå­¦ä¼šé—®ï¼Œä¸ºä»€ä¹ˆ A ä¼šè¢«è°ƒå’Œï¼ŒåŸå› æ˜¯ A å’Œ B æ˜¯åŒçº§ï¼Œå¦‚æœçˆ¶çº§å…ƒç´ è°ƒå’Œï¼Œå¹¶ä¸”å‘ä¸‹è°ƒå’Œï¼Œé‚£ä¹ˆçˆ¶çº§çš„ç¬¬ä¸€çº§å­é“¾ä¸Šçš„ fiber éƒ½ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ã€‚ä» fiber å…³ç³»ä¸Šçœ‹ï¼ŒRoot å…ˆè°ƒå’Œçš„æ˜¯ child æŒ‡é’ˆä¸Šçš„ A ï¼Œç„¶å A ä¼šé€€å‡ºå‘ä¸‹è°ƒå’Œï¼Œæ¥ä¸‹æ¥æ‰æ˜¯ sibling Bï¼Œæ¥ä¸‹æ¥ B ä¼šå‘ä¸‹è°ƒå’Œï¼Œé€šè¿‡ childLanes æ‰¾åˆ°å½“äº‹äºº Fï¼Œç„¶å F ä¼šè§¦å‘ render æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£å†³é—®é¢˜ 2ï¼ŒChild2 çš„è°ƒå’Œé—®é¢˜ã€‚

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ Bï¼ŒE ä¼šå‘ä¸‹è°ƒå’Œï¼Œå¦‚æœå®ƒä»¬æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆä¼š render ä¹ˆï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¦è®°ä½çš„æ˜¯è°ƒå’Œè¿‡ç¨‹å¹¶é render è¿‡ç¨‹ï¼Œè°ƒå’Œè¿‡ç¨‹æœ‰å¯èƒ½ä¼šè§¦å‘ render å‡½æ•°ï¼Œä¹Ÿæœ‰å¯èƒ½åªæ˜¯ç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œè€Œæœ¬èº«ä¸ä¼šæ‰§è¡Œ render

## render é˜¶æ®µ

```js title=react-reconciler/src/ReactFiberWorkLoop.new.js -> renderRootSync
function renderRootSync(root, lanes) {
  workLoopSync();
  /* workLoopå®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ commit é˜¶æ®µ */
  workInProgressRoot = null;
  workInProgressRootRenderLanes = NoLanes;
}
```

å¯ä»¥æŠŠ workLoopSync å½“ä½œä¸€ä¸ªå¾ªç¯è¿ä½œçš„åŠ å·¥å™¨ï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber å¯ä»¥å½“ä½œä¸€ä¸ªé›¶ä»¶ï¼Œæ¯ä¸€ä¸ªé›¶ä»¶éƒ½éœ€è¦è¿›å…¥åŠ å·¥å™¨ï¼Œå¦‚æœæ²¡æœ‰å¾…åŠ å·¥çš„é›¶ä»¶ï¼Œé‚£ä¹ˆåŠ å·¥å™¨æ‰åœæ­¢è¿è½¬ã€‚

```js title=react-reconciler/src/ReactFiberWorkLoop.new.js -> workLoopSync
function workLoopSync() {
  /* å¾ªç¯æ‰§è¡Œ performUnitOfWork ï¼Œä¸€ç›´åˆ° workInProgress ä¸ºç©º */
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}
```

![2](/img/Reactè¿›é˜¶å®è·µæŒ‡å—/99afa68f8ab94c93be41df70db0ae488_tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.png)
