<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/Blog/blog/rss.xml" title="Try&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Blog/blog/atom.xml" title="Try&#39;s Blog Atom Feed"><title data-react-helmet="true">npm &amp; yarn 包管理机制 | Try&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/npm&amp;yarn"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="npm &amp; yarn 包管理机制 | Try&#x27;s Blog"><meta data-react-helmet="true" name="description" content="npm 内部机制和背后的思考"><meta data-react-helmet="true" property="og:description" content="npm 内部机制和背后的思考"><link data-react-helmet="true" rel="shortcut icon" href="/Blog/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/npm&amp;yarn"><link data-react-helmet="true" rel="alternate" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/npm&amp;yarn" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/npm&amp;yarn" hreflang="x-default"><link rel="stylesheet" href="/Blog/assets/css/styles.c913d63a.css">
<link rel="preload" href="/Blog/assets/js/runtime~main.5a820360.js" as="script">
<link rel="preload" href="/Blog/assets/js/main.ebfc7a7e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Blog/"><div class="navbar__logo"><img src="/Blog/img/logo.png" alt="Try&#x27;s Blog" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/Blog/img/logo.png" alt="Try&#x27;s Blog" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Try&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/Blog/docs/quick-link">技术</a><a class="navbar__item navbar__link" href="/Blog/blog">生活</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/guoxiaxing/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Blog/docs/learn-list">学习清单</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Blog/docs/quick-link">目录</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CSS</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Javascript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Typescript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">学习提升</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">网络</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">工具</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">工程化</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">husky</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">包管理工具</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Blog/docs/工程化/包管理工具/npm&amp;yarn">npm &amp; yarn 包管理机制</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">npm</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">pnpm</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">yarn</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">CI&amp;CD</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">框架&amp;常用库</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">读书笔记</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>npm &amp; yarn 包管理机制</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="npm-内部机制和背后的思考">npm 内部机制和背后的思考<a aria-hidden="true" class="hash-link" href="#npm-内部机制和背后的思考" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="npm-install">npm install<a aria-hidden="true" class="hash-link" href="#npm-install" title="Direct link to heading">​</a></h3><p><img src="/Blog/assets/images/1647740334759-629f2a18-8bfa-4505-8339-b906c1a5cb6a-c6f021b643bb30d94f2e549f63090d25.png"></p><ul><li>检查配置。包括项目级、用户级、全局级、内置的 .npmrc 文件。</li><li>构建依赖。根据 package.json 和 lock file。如果 package-lock.json 文件存在且符合 package.json 声明的的情况下，直接读取；否则重新确认依赖的版本。</li><li>下载包资源。先检查本地缓存中是否存在匹配版本，有则直接解压到项目的 node_modules 中；如果没有则重新下载并添加到缓存，然后将包按依赖树解压到 node_modules 目录</li><li>生成 lock file</li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>需要明确几点信息：</p><ol><li><p>在构建依赖的时候需要结合 package.json 和 lock file 两个文件。先确认 package-lock.json 安装版本，符合规则就以此为准，否则由 package.json 声明的版本范围重新确认。特别地，若是在开发中手动更改包信息，会导致 lockfile 版本信息异常，也可能由 package.json 确认。确认好的依赖树会存到 package-lock.json 文件中。</p></li><li><p>如果一个包被多个依赖所依赖，那么第一个解析到的版本会被安装在顶层，其余的不同版本则会被安装到依赖自己的node_modules目录下</p></li><li><p>如果依赖升级，造成版本不兼容，需要多版本共存，那么仍然按照2</p></li></ol></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yarn">yarn<a aria-hidden="true" class="hash-link" href="#yarn" title="Direct link to heading">​</a></h2><p>yarn解决了当时npm存在的问题</p><ul><li>确定性。lock文件保证了依赖版本的确定性，保证在所有电脑上install都可以得到一致的结果。</li><li>依赖扁平化。（npm 也有相同的优化)</li><li>更好的网络性能。Yarn 采用了请求排队的理念，类似并发连接池，能够更好地利用网络资源；同时引入了更好的安装失败时的重试机制。（npm 较早的版本是顺序下载，当第一个包完全下载完成后，才会将下载控制权交给下一个包)</li><li>引入缓存机制，实现离线策略。（npm 也有类似的优化)</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="yarnlock文件">yarn.lock文件<a aria-hidden="true" class="hash-link" href="#yarnlock文件" title="Direct link to heading">​</a></h3><p>以 React 为例</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># yarn lockfile v1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expect-jsx@^5.0.0: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> version &quot;5.0.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> resolved &quot;[http://registry.npmjs.org/expect-jsx/-/expect-jsx-5.0.0.tgz#61761b43365f285a80eb280c785e0783bbe362c7](http://registry.npmjs.org/expect-jsx/-/expect-jsx-5.0.0.tgz#61761b43365f285a80eb280c785e0783bbe362c7 &quot;http://registry.npmjs.org/expect-jsx/-/expect-jsx-5.0.0.tgz#61761b43365f285a80eb280c785e0783bbe362c7&quot;)&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> integrity sha1-YXYbQzZfKFqA6ygMeF4Hg7vjYsc= </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> dependencies: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> collapse-white-space &quot;^1.0.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react &quot;^16.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> react-element-to-jsx-string &quot;^13.0.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react-rater@^6.0.0: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> version &quot;6.0.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> resolved &quot;[http://registry.npmjs.org/react-rater/-/react-rater-6.0.0.tgz#2e666b6e5e5c33b622541df6a7124f6c99606927](http://registry.npmjs.org/react-rater/-/react-rater-6.0.0.tgz#2e666b6e5e5c33b622541df6a7124f6c99606927 &quot;http://registry.npmjs.org/react-rater/-/react-rater-6.0.0.tgz#2e666b6e5e5c33b622541df6a7124f6c99606927&quot;)&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> integrity sha512-NP1+rEeL3LyJqA5xF7U2fSHpISMcVeMgbQ0u/P1WmayiHccI7Ixx5GohygmJY82g7SxdJnIun2OOB6z8WTExmg== </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> dependencies: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> prop-types &quot;^15.7.2&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react &quot;^16.8.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> react-dom &quot;^16.8.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//一或多个具有相同版本范围的依赖声明，确定一个可用的版本。这就是 lockfile 的确定性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react@^16.0.0, react@^16.8.0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version &quot;16.14.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> resolved &quot;[http://registry.npmjs.org/react/-/react-16.14.0.tgz#94d776ddd0aaa37da3eda8fc5b6b18a4c9a3114d](http://registry.npmjs.org/react/-/react-16.14.0.tgz#94d776ddd0aaa37da3eda8fc5b6b18a4c9a3114d &quot;http://registry.npmjs.org/react/-/react-16.14.0.tgz#94d776ddd0aaa37da3eda8fc5b6b18a4c9a3114d&quot;)&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> integrity sha512-0X2CImDkJGApiAlcf0ODKIneSwBPhqJawOa5wCtKbu7ZECrmS26NvtSILynQ66cgkT/RJ4LidJOc3bUESwmU8g== </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> dependencies: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> loose-envify &quot;^1.1.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> object-assign &quot;^4.1.1&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> prop-types &quot;^15.6.2&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//如果同一个依赖存在多个版本，那么最高版本安装在顶层目录，即 node_modules 目录。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react@^17.0.1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version &quot;17.0.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> resolved &quot;[http://registry.npmjs.org/react/-/react-17.0.2.tgz#d0b5cc516d29eb3eee383f75b62864cfb6800037](http://registry.npmjs.org/react/-/react-17.0.2.tgz#d0b5cc516d29eb3eee383f75b62864cfb6800037 &quot;http://registry.npmjs.org/react/-/react-17.0.2.tgz#d0b5cc516d29eb3eee383f75b62864cfb6800037&quot;)&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> integrity sha512-gnhPt75i/dq/z3/6q/0asP78D0u592D5L1pd7M8P+dck6Fu/jJeL6iVVK23fptSUZj8Vjf++7wXA8UNclGQcbA== </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> dependencies: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> loose-envify &quot;^1.1.0&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> object-assign &quot;^4.1.1&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>注意一下几点：</p><ol><li>所有依赖，不管是项目声明的依赖，还是依赖的依赖，都是扁平化管理。</li><li>依赖的版本是由所有依赖的版本声明范围确定的，具备相同版本声明范围的依赖归结为一类，确定一个该范围下的依赖版本。如果同一个依赖多个版本共存，那么会并列归类。</li><li>每个依赖确定的版本中，是由以下几项构成：<ul><li>多个依赖的声明版本，且符合 semver 规范；</li><li>确定的版本号 version 字段；</li><li>版本的完整性验证字段</li><li>依赖列表</li></ul></li><li>相比 npm，Yarn 一个显著区别是 yarn.lock 中子依赖的版本号不是固定版本。 也就是说单独一个 yarn.lock 确定不了 node_modules 目录结构，还需要和 package.json 文件进行配合。</li></ol></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="yarn-install">yarn install<a aria-hidden="true" class="hash-link" href="#yarn-install" title="Direct link to heading">​</a></h3><p><img src="/Blog/assets/images/1647741890271-bb8b32d2-7dfe-4def-bcac-84f27556c19c-dc0c488e500cd7c8bcee2e25d4ca319c.png"></p><ol><li><p>检查（checking）主要是检查项目中是否存在一些 npm 相关的配置文件，如 package-lock.json 等。如果存在，可能会警告提示，因为它们可能会存在冲突。</p></li><li><p>解析包（resolving packages）这一步主要是解析依赖树，确定版本信息等。首先获取项目 package.json 中声明的首层依赖，包括 dependencies, devDependencies, optionalDependencies 声明的依赖。接着采用遍历首层依赖的方式获取依赖包的版本信息，以及递归查找每个依赖下嵌套依赖的版本信息，并将解析过和正在解析的包用一个 Set 数据结构来存储，这样就能保证同一个版本范围内的包不会被重复解析。</p><ul><li>对于没有解析过的包，首次尝试从 yarn.lock 中获取到版本信息，并标记为已解析；</li><li>如果在 yarn.lock 中没有找到包，则向 Registry 发起请求获取满足版本范围的已知最高版本的包信息，获取后将当前包标记为已解析。</li></ul></li><li><p>获取包（fetching packages）这一步主要是利用系统缓存，到缓存中找到具体的包资源。首先会尝试在缓存中查找依赖包，如果没有命中缓存，则将依赖包下载到缓存中。对于没有命中缓存的包，Yarn 会维护一个 fetch 队列，按照规则进行网络请求。这里也是 yarn 诞生之初解决 npm v3 安装缓慢问题的优化点，支持并行下载。</p></li><li><p>链接包（linking dependencies）这一步主要是将缓存中的依赖，复制到项目目录下，同时遵循扁平化原则。前面说到，npm 优先将依赖安装到项目目录，因此需要将全局缓存中的依赖复制到项目。在复制依赖前，Yarn 会先解析 peerDependencies，如果找不到符合 peerDependencies 声明的依赖版本，则进行 warning 提示（这并不会影响命令执行），并最终拷贝依赖到项目中。</p></li><li><p>构建包（building fresh package）如果依赖包中存在二进制包需要进行编译，会在这一步进行。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="如何破解依赖管理困境">如何破解依赖管理困境<a aria-hidden="true" class="hash-link" href="#如何破解依赖管理困境" title="Direct link to heading">​</a></h3><p>在 npm v2 时期，安装的依赖会存在于引用依赖的 node_modules 目录，如果依赖过多，会形成一颗巨大的依赖树。这种结构虽然简单明了，但是对于大型项目十分不友好。依赖层级深对开发排查不利，并且依赖的复用也是问题。在 npm v3 中引入扁平化的概念。</p><ul><li>场景一：不同 npm 版本安装依赖的结构</li></ul><p><a href="mailto:pkg-a@1.0.0" target="_blank" rel="noopener noreferrer">pkg-a@1.0.0</a> 依赖 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a>，npm v3 是扁平化管理依赖。</p><p><img src="/Blog/assets/images/1647742384281-f73814df-5187-4635-ad1d-169ad3347dfb-ba52d74128e2eb3f365e2b0d233dfda0.png"></p><ul><li>场景二：不同 npm 版本处理依赖多版本共存问题 </li></ul><p>在场景一的基础上，安装 <a href="mailto:pkg-c@1.0.0" target="_blank" rel="noopener noreferrer">pkg-c@1.0.0</a>，而它依赖另一个版本的 <a href="mailto:pgk-b@2.0.0" target="_blank" rel="noopener noreferrer">pgk-b@2.0.0</a>。由于根目录下已存在 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a> 的依赖，npm v3 会把 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 安装到 <a href="mailto:pkg-c@1.0.0" target="_blank" rel="noopener noreferrer">pkg-c@1.0.0</a> 依赖的 node_modules 目录。</p><p><img src="/Blog/assets/images/1647742530513-532b91f9-1a70-4f20-ab7e-4f503747fcbb-77914df7724efb71ddfdc2f2d45131df.png"></p><p>为什么 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a> 在顶级，而 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 在子级呢？不是刚才说<strong>将高版本安装到顶层，低版本分散到各级目录。</strong>？</p><ul><li>场景三：依赖的多版本的数量与依赖版本分布关系 </li></ul><p>在场景二的基础上，安装 <a href="mailto:pkg-d@1.0.0" target="_blank" rel="noopener noreferrer">pkg-d@1.0.0</a>，而它也依赖 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a>。同样的，由于根目录下已存在 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a> 的依赖，npm v3 会把 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 安装到 <a href="mailto:pkg-d@1.0.0" target="_blank" rel="noopener noreferrer">pkg-d@1.0.0</a> 依赖的 node_modules 目录。</p><p><img src="/Blog/assets/images/1647742643759-6f2103af-8878-413a-accf-fa4dce969af3-905582978c9da18a051cbdcdc0962fdb.png"></p><p>你可能会疑问，此时存在2个 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 和1个 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a>，出现在顶级安装目录的不应该是 v2 版本而非 v1 版本嘛？</p><p><strong>其实这是由依赖的安装顺序决定的</strong>，真就是依赖的某个版本如果出现在合适的时间，那么它就会被安装到顶级 node_modules 目录。不同版本的出场顺序导致依赖结构的差异，npm v3 注定不是稳定的包管理工具。</p><ul><li>场景四：依赖版本存在重复和可用 </li></ul><p>在场景三的基础上，安装 <a href="mailto:pkg-e@1.0.0" target="_blank" rel="noopener noreferrer">pkg-e@1.0.0</a>，它依赖 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a>。由于顶级目录已存在目标版本，因此 npm v3 会跳过该依赖的安装。</p><p><img src="/Blog/assets/images/1647742760122-f869054f-dff0-40c0-9cb8-72bcdf622cd6-d2023f4b25ec60aa69a1ead82f091e17.png"></p><ul><li>场景五：版本升级囧境在</li></ul><p>场景三的基础上，如果更新了 <a href="mailto:pkg-a@2.0.0" target="_blank" rel="noopener noreferrer">pkg-a@2.0.0</a>，同时它的依赖是 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a>。那么 npm v3 的执行顺序是，删除 <a href="mailto:pkg-a@1.0.0" target="_blank" rel="noopener noreferrer">pkg-a@1.0.0</a>，安装 <a href="mailto:pkg-a@2.0.0" target="_blank" rel="noopener noreferrer">pkg-a@2.0.0</a>，安装 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a>，留下了 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a> 在顶层目录，因此 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 会安装到 <a href="mailto:pkg-a@2.0.0" target="_blank" rel="noopener noreferrer">pkg-a@2.0.0</a> 的 node_modules 目录。</p><p><img src="/Blog/assets/images/1647742916020-75bec502-a31e-4327-ad4e-827d6431ca03-37780c4e4c90a4bbe63601c43a8e28e5.png"></p><ul><li>场景六：依赖版本多目录存在且符合复用条件 </li></ul><p>在场景五的基础上，更新 <a href="mailto:pkg-e@2.0.0" target="_blank" rel="noopener noreferrer">pkg-e@2.0.0</a>，它依赖了 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a>。那么 npm v3 的执行顺序是，删除 <a href="mailto:pkg-e@1.0.0" target="_blank" rel="noopener noreferrer">pkg-e@1.0.0</a>，安装 <a href="mailto:pkg-e@2.0.0" target="_blank" rel="noopener noreferrer">pkg-e@2.0.0</a>，删除 <a href="mailto:pkg-b@1.0.0" target="_blank" rel="noopener noreferrer">pkg-b@1.0.0</a>，安装 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a>，于是出现以下结构。</p><p><img src="/Blog/assets/images/1647743016569-a1e996d0-d443-4cfa-82b5-b2986108d531-c4a4746c3930ea70a53aed8a298a3470.png"></p><p>此时你会发现，存在多个 <a href="mailto:pkg-b@2.0.0" target="_blank" rel="noopener noreferrer">pkg-b@2.0.0</a> 分布在不同的 node_modules 目录，他们是不是只要在顶级目录存在一份即可？没错，我们删除 node_modules 目录重装，得到的就是你想的清晰的结构。</p><p><img src="/Blog/assets/images/1647743181494-46252fd9-6dae-4d13-b6cc-87ab1594b0a2-0e61ca194740938e9a88ab5fda987c8b.png"></p><p>实际上，更优雅的方式是使用 npm dedupe 命令达到上述结构。而 yarn 在安装依赖时会自动执行 dedupe 命令。</p><p>正是由于上述一些 npm 历史的坑，所以更建议使用 yarn 作为项目协作的包管理工具。当然 npm 发展至今，很多问题已经优化掉，现在 yarn 和 npm 是两款互相看齐、互相获取灵感的依赖管理工具。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="npm-vs-yarn-">npm vs. yarn 💪<a aria-hidden="true" class="hash-link" href="#npm-vs-yarn-" title="Direct link to heading">​</a></h2><p>npm 和 yarn 作为两款相似的包管理工具，在一些功能实现上它们互相获取灵感。</p><p>相同点：</p><ol><li><p>package.json 作为项目依赖描述文件。</p></li><li><p>lockfile 锁定版本依赖，在 yarn 中叫 yarn.lock，在 npm 中叫 package-lock.json，在 npm v7 也支持了 yarn.lock。它确保在不同机器或不同环境中，能够得到稳定的 node_modules 目录结构。</p></li></ol><p>差异：</p><ol><li>依赖管理策略。</li><li>lockfile。<strong>package-lock.json 自带版本锁定+依赖结构，你想改动一些依赖，可能影响的范围要比表面看起来的复杂的多；而 yarn.lock 自带版本锁定，并没有确定的依赖结构，使用 yarn 管理项目依赖，需要 package.json + yarn.lock 共同确定依赖的结构。</strong></li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="注意-cnpm-不支持-package-lock">注意 cnpm 不支持 package-lock<a aria-hidden="true" class="hash-link" href="#注意-cnpm-不支持-package-lock" title="Direct link to heading">​</a></h2><p>使用 cnpm install 时候，并不会生成 package-lock.json 文件。cnpm install 的时候，就算你项目中有 package-lock.json 文件，cnpm 也不会识别，仍会根据 package.json 来安装。所以这就是为什么之前你用 npm 安装产生了 package-lock.json，后面的人用 cnpm 来安装，可能会跟你安装的依赖包不一致。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/Blog/docs/tags/yarn">yarn</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/Blog/docs/tags/npm">npm</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Blog/docs/工程化/husky/husky"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->husky 7.x 使用</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Blog/docs/工程化/包管理工具/npm/npm-tag"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">npm tag<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#npm-内部机制和背后的思考" class="table-of-contents__link toc-highlight">npm 内部机制和背后的思考</a><ul><li><a href="#npm-install" class="table-of-contents__link toc-highlight">npm install</a></li></ul></li><li><a href="#yarn" class="table-of-contents__link toc-highlight">yarn</a><ul><li><a href="#yarnlock文件" class="table-of-contents__link toc-highlight">yarn.lock文件</a></li><li><a href="#yarn-install" class="table-of-contents__link toc-highlight">yarn install</a></li><li><a href="#如何破解依赖管理困境" class="table-of-contents__link toc-highlight">如何破解依赖管理困境</a></li></ul></li><li><a href="#npm-vs-yarn-" class="table-of-contents__link toc-highlight">npm vs. yarn 💪</a></li><li><a href="#注意-cnpm-不支持-package-lock" class="table-of-contents__link toc-highlight">注意 cnpm 不支持 package-lock</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/Blog/assets/js/runtime~main.5a820360.js"></script>
<script src="/Blog/assets/js/main.ebfc7a7e.js"></script>
</body>
</html>