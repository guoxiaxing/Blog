<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/Blog/blog/rss.xml" title="Try&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Blog/blog/atom.xml" title="Try&#39;s Blog Atom Feed"><title data-react-helmet="true">关于 yarn 你需要知道的 | Try&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/yarn/about-yarn"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="关于 yarn 你需要知道的 | Try&#x27;s Blog"><meta data-react-helmet="true" name="description" content="重要：永远不要手动去修改 yarn.lock 文件"><meta data-react-helmet="true" property="og:description" content="重要：永远不要手动去修改 yarn.lock 文件"><link data-react-helmet="true" rel="shortcut icon" href="/Blog/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/yarn/about-yarn"><link data-react-helmet="true" rel="alternate" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/yarn/about-yarn" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://guoxiaxing.github.io/Blog/docs/工程化/包管理工具/yarn/about-yarn" hreflang="x-default"><link rel="stylesheet" href="/Blog/assets/css/styles.c913d63a.css">
<link rel="preload" href="/Blog/assets/js/runtime~main.e655d27b.js" as="script">
<link rel="preload" href="/Blog/assets/js/main.98612a44.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Blog/"><div class="navbar__logo"><img src="/Blog/img/logo.png" alt="Try&#x27;s Blog" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/Blog/img/logo.png" alt="Try&#x27;s Blog" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Try&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/Blog/docs/quick-link">技术</a><a class="navbar__item navbar__link" href="/Blog/blog">生活</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/guoxiaxing/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Blog/docs/learn-list">学习清单</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Blog/docs/quick-link">目录</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CSS</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Javascript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Typescript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">学习提升</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">框架&amp;常用库</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">网络</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">工具</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">工程化</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">husky</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">包管理工具</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Blog/docs/工程化/包管理工具/npm&amp;yarn">npm &amp; yarn 包管理机制</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">npm</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">pnpm</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">yarn</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Blog/docs/工程化/包管理工具/yarn/about-yarn">关于 yarn 你需要知道的</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">CI&amp;CD</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">读书笔记</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>关于 yarn 你需要知道的</h1></header><p><strong>重要：永远不要手动去修改 yarn.lock 文件</strong></p><p><strong>重要：永远不要手动去修改 package.json 文件，如果你需要使用一个包的最新版本，可以使用 <code>yarn upgrade</code> 命令来去升级该 package，它会自动安装最新版本并且更新 yarn.lock 文件</strong></p><p><strong>重要：永远不要随便的就去删除 node_modules 文件和 yarn.lock 文件去重新 install，因为它可能会更新一些你并不想更新的包，而带来一些难以预料的问题</strong></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="registry">registry<a aria-hidden="true" class="hash-link" href="#registry" title="Direct link to heading">​</a></h2><p>其实就是查询下载每个模块的源。</p><p>当我们执行 <code>yarn install</code> 时候，就是去 <code>registry</code> 查询得到 package 压缩包地址进行下载的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">yarn</span><span class="token plain"> config get registry </span><span class="token comment" style="color:#999988;font-style:italic"># 查看当前使用的源</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">yarn</span><span class="token plain"> config </span><span class="token builtin class-name">set</span><span class="token plain"> registry url </span><span class="token comment" style="color:#999988;font-style:italic"># 设置源</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="依赖版本">依赖版本<a aria-hidden="true" class="hash-link" href="#依赖版本" title="Direct link to heading">​</a></h2><p>yarn 的包遵守语义化版本，格式为</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">X.Y.Z（主版本号.次版本号.修订号）：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X.主版本号：进行不向下兼容的修改时，递增主版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Y.次版本号: 做了向下兼容的新增功能或修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Z.修订号：做了向下兼容的问题修复</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="版本号version">版本号：~version<a aria-hidden="true" class="hash-link" href="#版本号version" title="Direct link to heading">​</a></h3><p>表示主版本号和次版本号相同，修订号取最新</p><table><thead><tr><th>表示</th><th>含义</th></tr></thead><tbody><tr><td>~3.1.4</td><td>&gt;=3.1.4 &lt;3.2.0</td></tr><tr><td>~3.1</td><td>3.1.x 或 &gt; = 3.1.0 &lt; 3.2.0</td></tr><tr><td>~3</td><td>3.x 或 &gt; = 3.0.0 &lt; 4.0.0</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_y2LR" id="版本号version-1">版本号：^version<a aria-hidden="true" class="hash-link" href="#版本号version-1" title="Direct link to heading">​</a></h3><p>表示主版本号相同，取最新版本</p><p>使用 <code>yarn add package</code>时，默认使用的是 ^ 范围。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="依赖类型">依赖类型<a aria-hidden="true" class="hash-link" href="#依赖类型" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="dependencies">dependencies<a aria-hidden="true" class="hash-link" href="#dependencies" title="Direct link to heading">​</a></h3><p>代码运行时所需要的依赖，比如 vue，vue-router。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="devdependencies">devDependencies<a aria-hidden="true" class="hash-link" href="#devdependencies" title="Direct link to heading">​</a></h3><p>开发依赖，就是那些只在开发过程中需要，而运行时不需要的依赖，比如 babel，webpack。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="peerdependencies">peerDependencies<a aria-hidden="true" class="hash-link" href="#peerdependencies" title="Direct link to heading">​</a></h3><p>同伴依赖，它用来告知宿主环境需要什么依赖以及依赖的版本范围。如果宿主环境没有对应版本的依赖，在安装依赖时会报出警告。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="optionaldependencies">optionalDependencies<a aria-hidden="true" class="hash-link" href="#optionaldependencies" title="Direct link to heading">​</a></h3><p>可选依赖，这种依赖即便安装失败，Yarn 也会认为整个依赖安装过程是成功的。可选依赖适用于那些即便没有成功安装可选依赖，也有后备方案的情况。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="bundleddependencies">bundledDependencies<a aria-hidden="true" class="hash-link" href="#bundleddependencies" title="Direct link to heading">​</a></h3><p>打包依赖，在发布包时，这个数组里的包都会被打包打包到最终的发布包里，需要注意 <code>bundledDependencies</code> 中的包必须是在 <code>devDependencies</code> 或 <code>dependencies</code> 声明过的。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="缓存">缓存<a aria-hidden="true" class="hash-link" href="#缓存" title="Direct link to heading">​</a></h2><p><code>yarn</code> 会将安装过的包缓存下来，<strong>这样再次安装相同包的时候，就不需要再去下载，而是直接从缓存文件中直接 copy 进来</strong>。</p><p>可以通过命令 <code>yarn cache dir</code> 查看 yarn 的全局缓存目录。</p><p>yarn 会将不通版本解压后的包存放在不同目录下，目录以</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">npm-[package name]-[version]-[shasum]`</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>shasum</code>是一个 hash 值，在 lock 和缓存时会使用到。</p><p>我们可以通过命令查看已经缓存过的包。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">yarn</span><span class="token plain"> cache list    列出已缓存的每个包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">yarn</span><span class="token plain"> cache list --pattern </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">  列出匹配指定模式的已缓存的包</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yarnlock">yarn.lock<a aria-hidden="true" class="hash-link" href="#yarnlock" title="Direct link to heading">​</a></h2><p><code>yarn.lock</code> 中会准确的存储每个依赖的具体版本信息，以保证在不同机器安装可以得到相同的结果。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="yarnlock-的作用">yarn.lock 的作用<a aria-hidden="true" class="hash-link" href="#yarnlock-的作用" title="Direct link to heading">​</a></h3><p>不要轻易的删除 yarn.lock 文件。</p><p>把 yarn.lock 删掉后，原本锁住的版本都放开了，执行 yarn install 的时候会根据 package.json 里定义的版本区间去找最新版。所以，可能会造成你预期外的依赖也被更新了，不幸的话可能会引入 bug。</p><p><strong>锁定唯一版本</strong></p><ul><li>package.json 里定义的是版本区间，如^1.0.0</li><li>而 yarn.lock 里的 version 字段是唯一的版本号，如 1.0.0</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ajax-hook@^2.0.3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version &quot;2.0.3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resolved &quot;http://npm.zhenguanyu.com/ajax-hook/download/ajax-hook-2.0.3.tgz#e9ceced02f940f6223123c7dc90fe2062d417c18&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  integrity sha1-6c7O0C+UD2IjEjx9yQ/iBi1BfBg=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;@utilts/z@^0.2.57&quot;, &quot;@utilts/z@^0.2.58&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version &quot;0.2.58&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resolved &quot;http://npm.zhenguanyu.com/@utilts/z/download/@utilts/z-0.2.58.tgz#df1ad9c27734e4efd18095d49239dede266bea1f&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  integrity sha1-3xrZwnc05O/RgJXUkjne3iZr6h8=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dependencies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;@utilts/zdata&quot; &quot;^0.2.58&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lodash-es &quot;^4.17.21&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query-string &quot;^6.11.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rxjs &quot;^6.6.7&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>第一行 <code>ajax-hook@^2.0.3</code> 包的 name 和语义化版本号，这些都来自 package.json 中的定义。也被称为 <code>Identifier(s)</code>，多个 Identifier 最终可能都指向同一个版本</p></li><li><p>version 记录的是一个确定的版本，也就是实际安装的版本</p></li><li><p>resolved 字段记录的是包的 URL 地址。其中 hash 值，即上文的<code>shasum</code></p></li><li><p>integrity 是对 resolved 下载下来的文件进行完整性校验。如果出现 diff，说明同一个下载链接对应的文件被修改过。</p></li><li><p>dependencies 字段记录的是当前包的依赖，即当前包在自己的 package.json 的 dependencies 字段中的所有依赖。</p></li></ul><p>Yarn 在安装期间，只会使用当前项目的 yarn.lock 文件，会忽略任何依赖里面的 yarn.lock 文件。在顶级 yarn.lock 中包含需要锁定的整个依赖树里全部包版本的所有信息。</p><p><strong>yarn.lock 文件是在安装期间，由 Yarn 自动生成的，并且由 yarn 来管理，不应该手动去更改，更不应该删除 yarn.lock 文件，且要提交到版本控制系统中，以免因为不同机器安装的包版本不一致引发问题。</strong></p><p>我们的常规操作(yarn add / yarn upgrade)都会自动更新 package.json 和 yarn.lock</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="packagejson-中的-resolutions-选项">package.json 中的 resolutions 选项<a aria-hidden="true" class="hash-link" href="#packagejson-中的-resolutions-选项" title="Direct link to heading">​</a></h3><p><strong>通过这个选项可以修改 yarn.lock 中某个 package 的版本</strong></p><p>假如你的项目依赖了 foo,foo 依赖了 bar@^1.0.0。假设 bar 现在有两个版本 1.0.0 和 1.1.0。很不幸，bar 在发布 1.1.0 的时候没有做好向后兼容。导致 foo 和 <a href="mailto:bar@1.1.0" target="_blank" rel="noopener noreferrer">bar@1.1.0</a> 不能搭配使用。如果你可以等：</p><ul><li>要么等 foo 把依赖 bar 锁成 1.0.0 并重新发版</li><li>要么等 bar 修复兼容问题后重新发版</li></ul><p>那如果你等不了呢，你已知 foo 和 <a href="mailto:bar@1.0.0" target="_blank" rel="noopener noreferrer">bar@1.0.0</a> 可以正常工作。如果你能锁住 foo 对 bar 的依赖就好了，但是这定义在 foo 的 packge.json 里，你总不能去改 node_modules/foo/package.json 吧？这不合适。resolutions 可以解决你的问题，只要在你自己项目的 package.json 里定义：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;resolutions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;foo/bar&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这里的 key&quot;foo/bar&quot;表示 foo 的直接依赖 bar，把版本区间重写成 1.0.0。如果 foo 不是直接依赖的 bar（foo -&gt; ... -&gt; bar），我还需要把中间的链路都捋清楚吗？不用那么麻烦！</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;resolutions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;foo/**/bar&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>如果你的项目里有很多依赖直接/间接的依赖了 bar，每个定义的版本区间可能有差别，你知道某个版本可以让他们都能正常工作，而不用安装多个版本。也可以不用声明前缀部分，只写包名 bar。这样不管是哪里依赖到了 bar 都会指向你声明的哪个版本。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;resolutions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;bar&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>执行 yarn install 后，在 yarn.lock 里搜索 bar@：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">bar@^1.0.0 bar@1.1.0 bar@^2.0.0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>可以看到，resolutions 可以违背版本区间的限制，比如上例中 Identifiers 里的 <a href="mailto:bar@1.1.0" target="_blank" rel="noopener noreferrer">bar@1.1.0</a>``bar@^2.0.0。</strong></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="yarn---frozen-lockfile--npm-ci">yarn --frozen-lockfile / npm ci<a aria-hidden="true" class="hash-link" href="#yarn---frozen-lockfile--npm-ci" title="Direct link to heading">​</a></h3><p>即使有 lock file 的存在，也无法保证在持续集成环境中每次安装依赖都和开发时一致，因为可能存在 package.json 和 lockfile 版本号不匹配并需要更新依赖版本的情况。可以使用--frozen-lockfile 来避免。</p><p>这两个命令的作用类似，必须存在 lock file 且依赖版本和 package.json 匹配时才会安装依赖，否则报错。如此可强制开发者在持续集成前先在本地解决依赖版本的一致性问题。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="yarn-install-的过程">yarn install 的过程<a aria-hidden="true" class="hash-link" href="#yarn-install-的过程" title="Direct link to heading">​</a></h2><p>首次执行 yarn install 安装，会按照 package.json 中的语义化版本，去向 registry 进行查询，并获取到符合版本规则的最新的依赖包进行下载，并构建构建依赖关系树。 比如在 package.json 中指定 react 的版本为 ^2.0.0，就会获取符合 2.x.x
的最高版本的包。然后自动生成 yarn.lock 文件，并生成缓存。</p><p>之后再执行 yarn install，会对比 package.json 中依赖版本范围和 yarn.lock 中版本号是否匹配。</p><ul><li><p>版本号匹配：会根据 yarn.lock 中的 resolved 字段去查看缓存， 如果有缓存，直接 copy，没有缓存则按照 resolved 字段的 url 去下载包。</p></li><li><p>版本号不匹配：根据 package.json 中的版本范围去 registry 查询，下载符合版本规则最新的包，并更新至 yarn.lock 中。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="模块扁平化">模块扁平化<a aria-hidden="true" class="hash-link" href="#模块扁平化" title="Direct link to heading">​</a></h2><p>假设我项目的首层依赖(即当前项目的 dependence 和 devDependences 中的依赖，不包括依赖的依赖)中有 A，B，C 三个包，A 和 B 包同时依赖了相同版本范围的 D 包。那么这部分的依赖关系树是这样的：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">├── A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ └── D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ └── D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── C</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>如果按照这样的依赖关系树直接安装的话，D 模块会在 A 包和 B 包的 node_modules 中都安装，这样会导致模块冗余。</p><p>为了保证依赖关系树中没有大量重复模块，yarn 在安装时会做 dedupe（去重）操作，它会遍历所有节点，逐个将模块放在根节点下面，也就是当前项目的 node-modules 中。当发现有相同的模块时，会判断当前模块指定的版本范围是否交集，如果有，则只保留兼容版本，如果没有则在当前的包的 node-modules 下安装。</p><p>所以上面的说的情况，最终安装完成是下面这样的，A，B，C，D 包都会安装在第一层 node-modules 下（在依赖的 D 版本兼容的情况下）。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">├── A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>如果 A 包和 B 包依赖的是不兼容的版本，假设 A 包依赖的是 D@1 版本的包，B 包依赖的是 D@2 版本。则最终安装的结果如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">├── A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ └── D@2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── D@1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至于是 D 的那个版本被安装在根目录的 node_modules 下，取决的是模块解析的顺序，先解析到的 D 的指定版本会被安装到根 node_modules，后解析到的 D 且不兼容已有版本时，会被安装到对应模块的 node_modules 下</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/Blog/docs/tags/yarn">yarn</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Blog/docs/工程化/包管理工具/pnpm/pnpm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->pnpm又是什么？</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Blog/docs/工程化/CI&amp;CD/GitHub Actions/articles"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">相关文章<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#registry" class="table-of-contents__link toc-highlight">registry</a></li><li><a href="#依赖版本" class="table-of-contents__link toc-highlight">依赖版本</a><ul><li><a href="#版本号version" class="table-of-contents__link toc-highlight">版本号：~version</a></li><li><a href="#版本号version-1" class="table-of-contents__link toc-highlight">版本号：^version</a></li></ul></li><li><a href="#依赖类型" class="table-of-contents__link toc-highlight">依赖类型</a><ul><li><a href="#dependencies" class="table-of-contents__link toc-highlight">dependencies</a></li><li><a href="#devdependencies" class="table-of-contents__link toc-highlight">devDependencies</a></li><li><a href="#peerdependencies" class="table-of-contents__link toc-highlight">peerDependencies</a></li><li><a href="#optionaldependencies" class="table-of-contents__link toc-highlight">optionalDependencies</a></li><li><a href="#bundleddependencies" class="table-of-contents__link toc-highlight">bundledDependencies</a></li></ul></li><li><a href="#缓存" class="table-of-contents__link toc-highlight">缓存</a></li><li><a href="#yarnlock" class="table-of-contents__link toc-highlight">yarn.lock</a><ul><li><a href="#yarnlock-的作用" class="table-of-contents__link toc-highlight">yarn.lock 的作用</a></li><li><a href="#packagejson-中的-resolutions-选项" class="table-of-contents__link toc-highlight">package.json 中的 resolutions 选项</a></li><li><a href="#yarn---frozen-lockfile--npm-ci" class="table-of-contents__link toc-highlight">yarn --frozen-lockfile / npm ci</a></li></ul></li><li><a href="#yarn-install-的过程" class="table-of-contents__link toc-highlight">yarn install 的过程</a></li><li><a href="#模块扁平化" class="table-of-contents__link toc-highlight">模块扁平化</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/Blog/assets/js/runtime~main.e655d27b.js"></script>
<script src="/Blog/assets/js/main.98612a44.js"></script>
</body>
</html>